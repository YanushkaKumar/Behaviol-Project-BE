name: Deploy to GCP

on:
  push:
    branches:
      - master
      - gke-release

jobs:
  # ======================================================
  # üñ•Ô∏è VM DEPLOYMENT (For Production / Testing)
  # ======================================================
  deploy-to-vm:
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build Spring Boot JAR
        run: mvn clean package -DskipTests

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Install gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          install_components: compute

      - name: Copy JAR to VM and Restart Service
        run: |
          gcloud compute scp target/*.jar \
            ${{ secrets.GCP_VM_NAME }}:~/new-todo-backend.jar \
            --zone=${{ secrets.GCP_VM_ZONE }}
          
          gcloud compute ssh ${{ secrets.GCP_VM_NAME }} \
            --zone=${{ secrets.GCP_VM_ZONE }} \
            --command="set -euo pipefail; \
              echo 'Stopping service...'; \
              sudo systemctl stop todo-backend.service || true; \
              echo 'Deploying new JAR...'; \
              sudo mv ~/new-todo-backend.jar /opt/myapp/todo-backend.jar; \
              sudo chown root:root /opt/myapp/todo-backend.jar; \
              sudo chmod 644 /opt/myapp/todo-backend.jar; \
              echo 'Starting service...'; \
              sudo systemctl start todo-backend.service; \
              echo 'Deployment complete!'; \
              sudo systemctl --no-pager --full status todo-backend.service"
  # ======================================================
  # ‚ò∏Ô∏è GKE DEPLOYMENT (Kubernetes)
  # ======================================================
  deploy-to-gke:
    if: github.ref == 'refs/heads/gke-release'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build Spring Boot JAR
        run: mvn clean package -DskipTests

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build Docker Image
        run: |
          docker build -t ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.ARTIFACT_REPO_NAME }}/todo-backend:${{ github.sha }} .
          docker tag ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.ARTIFACT_REPO_NAME }}/todo-backend:${{ github.sha }} \
            ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.ARTIFACT_REPO_NAME }}/todo-backend:latest

      - name: Push Docker Image to Artifact Registry
        run: |
          docker push ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.ARTIFACT_REPO_NAME }}/todo-backend:${{ github.sha }}
          docker push ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.ARTIFACT_REPO_NAME }}/todo-backend:latest

      - name: Install kubectl
        uses: azure/setup-kubectl@v4

      - name: Install GKE Auth Plugin
        run: gcloud components install gke-gcloud-auth-plugin --quiet

      - name: Get GKE Credentials
        run: |
          gcloud container clusters get-credentials ${{ secrets.GKE_CLUSTER_NAME }} \
            --zone=${{ secrets.GKE_ZONE }} \
            --project=${{ secrets.GCP_PROJECT_ID }}

      # --- App secrets (env) ---
      - name: Create or Update Kubernetes Secret
        run: |
          kubectl delete secret todo-backend-secret -n todo-backend --ignore-not-found
          kubectl create secret generic todo-backend-secret \
            --from-literal=SPRING_DATA_MONGODB_URI='${{ secrets.MONGODB_URI }}' \
            --from-literal=SPRING_DATA_MONGODB_DATABASE='todoapp' \
            --from-literal=JWT_SECRET='${{ secrets.JWT_SECRET }}' \
            --from-literal=JWT_EXPIRATION='86400000' \
            --from-literal=CORS_ALLOWED_ORIGINS='${{ secrets.CORS_ALLOWED_ORIGINS }}' \
            --from-literal=SERVER_PORT='5050' \
            -n todo-backend

      # --- Ensure Service & BackendConfig are correct each run ---
      - name: Apply BackendConfig & Service
        run: |
          kubectl apply -f k8s/04-backendconfig.yaml
          kubectl apply -f k8s/backend-service.yaml

      # --- Update the image ---
      - name: Update Deployment Image
        run: |
          kubectl set image deployment/todo-backend \
            todo-backend=${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.ARTIFACT_REPO_NAME }}/todo-backend:${{ github.sha }} \
            -n todo-backend

      # --- Time-boxed rollout + rollback on failure ---
      - name: Wait for Rollout (max 3 min, with rollback)
        run: |
          set +e
          kubectl rollout status deployment/todo-backend -n todo-backend --timeout=180s
          RC=$?
          if [ $RC -ne 0 ]; then
            echo "‚ùå Rollout failed, printing describe:"
            kubectl describe deployment todo-backend -n todo-backend || true
            echo "Undoing rollout..."
            kubectl rollout undo deployment/todo-backend -n todo-backend
            exit 1
          fi
          set -e

      # --- Show Ingress host + IP ---
      - name: Get Ingress Endpoint
        run: |
          echo "=== Ingress Host ==="
          kubectl get ingress todo-app-ingress -n todo-backend -o jsonpath='{.spec.rules[0].host}{"\n"}'
          echo "=== Ingress External IP ==="
          kubectl get ingress todo-app-ingress -n todo-backend -o jsonpath='{.status.loadBalancer.ingress[0].ip}{"\n"}'

      # --- Health check via Ingress (HTTP) with retries ---
      - name: Test Health via Ingress (retries)
        env:
          - name: Test Health via Ingress (retries)
            run: |
              DOMAIN="todoappilicationvm.danushka.tech"
              echo "Probing http://$DOMAIN/api/actuator/health"
              ATTEMPTS=12
              SLEEP=10
              OK=0
              for i in $(seq 1 $ATTEMPTS); do
                CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://$DOMAIN/api/actuator/health" || true)
                echo "Attempt $i: HTTP $CODE"
                if [ "$CODE" = "200" ]; then
                  OK=1
                  break
                fi
                sleep $SLEEP
              done
              if [ "$OK" -ne 1 ]; then
                echo "‚ùå Ingress is not returning 200 even after $((ATTEMPTS*SLEEP)) seconds"
                kubectl describe ingress todo-app-ingress -n todo-backend || true
                kubectl get svc todo-backend-service -n todo-backend -o yaml || true
                exit 1
              fi
              echo "‚úÖ Ingress health OK"
